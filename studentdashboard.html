<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - EdUpdate</title>
    <link rel="stylesheet" href="css/bootstrap-icons.css">
    <style>
      @font-face {
        font-family: "Poppins";
        src: url("fonts/Poppins-Regular.otf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      @font-face {
        font-family: "Poppins";
        src: url("fonts/Poppins-Bold.otf") format("truetype");
        font-weight: bold;
        font-style: normal;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins';
      }
      body {
        background-color: #FFFFFF;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .container {
        display: flex;
        height: 100%;
      }

      .sidebar {
        width: 230px;
        background: #18417F;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        box-shadow: 2px 0 8px rgba(30, 58, 95, 0.08);
        overflow: visible;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
        padding: 20px;
      }

      .logo img {
        width: 40px;
        height: 60px;
      }

      .logo-text h2 {
        font-size: 20px;
        color: #f4d35e;
      }

      .logo-text p {
        font-size: 14px;
        color: #dbe4f3;
      }

      .sidebar nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 40px;
        margin-bottom: 32px;
      }

      .sidebar nav a {
        display: block;
        color: #eaf1ff;
        text-decoration: none;
        font-size: 18px;
        font-weight: 500;
        padding: 10px 10px;
        border-radius: 8px;
        transition: background 0.18s, color 0.18s;
        margin-bottom: 2px;
      }

      .sidebar nav a.active,
      .sidebar nav a:hover {
        background: #fef6f0;
        color: #1e3a5f;
        font-weight: bold;
        border: 1px solid black;
        box-shadow: 0 2px 8px rgba(30, 58, 95, 0.08);
        width: 250px;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-top-right-radius: 50px;
        border-bottom-right-radius: 50px;
        margin-right: -30px;
        z-index: 1;
      }

      .sidebar .help button {
        background: #18417f;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px;
        margin-top: 330px;
        font-size: 18px;
        cursor: pointer;
        transition: background 0.18s, color 0.18s;
      }

      .sidebar .help button:hover {
        background: #18417f;
        color: black;
      }
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
     .header {
        background-color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .header .welcome {
        color: black;
        padding-left: 50px;
      }

      .header .profile {
        display: flex;
        align-items: center;
        gap: 10px;
        display: inline-flex;
        align-items: center;
        background-color: #C9D9FF;
        padding: 8px 32px 8px 20px;
        border-radius: 50px;
        border: 2px solid black;
        min-width: 300px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <img src="image/EdUpdate-logo.png" alt="EdUpdate Logo" />
          <div class="logo-text">
            <h2>EdUpdate</h2>
            <p>Student Dashboard</p>
          </div>
        </div>
        <nav>
          <a href="#" id="dashboardTab" onclick="showStudentSection('dashboard')"><i class="bi bi-grid-fill"></i> Dashboard</a>
          <a href="#" id="profileTab" onclick="showStudentSection('profile')"><i class="bi bi-person-fill"></i> Profile</a>
          <a href="index.html"><i class="bi bi-door-open-fill"></i> Log Out</a>
        </nav>
        <div class="help">
          <button onclick="openStudentHelpModal()"><i class="bi bi-question-circle-fill"></i> Help</button>
        </div>
      </aside>
      <!-- Main Content -->
      <main class="main-content">
        <!-- Header -->
        <header class="header">
          <div class="welcome">
            <p style="font-size: 20px;">Welcome Back, <span id="studentName">Student</span>!</p>
            <h3 style="font-size: 30px;">Exclusive Offers Await!</h3>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button onclick="openChatModal()" style="background-color: #C9D9FF; border: 2px solid black; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.backgroundColor='#94b5d9'" onmouseout="this.style.backgroundColor='#C9D9FF'">
              <i class="bi bi-chat-dots-fill" style="font-size: 24px; color: #1e3a5f;"></i>
            </button>
            <div class="profile">
              <img src="image/robot.png" alt="profile" class="avatar" style="width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  background: #b0c4de;
                  margin-right: 10px;
                  border: 2px solid black;" />
              <div>
                <p style="margin-bottom: 2px"><strong id="studentNameHeader">Student</strong></p>
                <small id="studentNoHeader">No.</small>
              </div>
            </div>
          </div>
        </header>
        <div id="studentDashboardSection" style="flex:1;display:flex;flex-direction:row;gap:32px;padding:32px;">
          <!-- Left: Profile + Quiz -->
          <div style="flex:1;display:flex;flex-direction:column;gap:24px;">
            <div class="profile-card" style="background:#E7E7E7;border:1.5px solid #222;border-radius:14px;padding:24px 32px 18px 32px;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between;">
              <div class="profile-info" style="display:flex;flex-direction:column;gap:6px;align-items:flex-start;">
                <strong style="font-size:1.25rem;color:#222;letter-spacing:0.01em;">STUDENT PROFILE: <span style="color:green;font-size:1.1rem;vertical-align:middle;">●</span></strong>
                <span style="font-size:1.08rem;color:#222;font-weight:500;">Name: <span id="profileName">Student</span></span>
                <span style="font-size:1.08rem;color:#222;font-weight:500;">Student ID: <span id="profileNo">-</span></span>
                <span style="font-size:1.08rem;color:#222;font-weight:500;">Course &amp; Section: <span id="profileCourse">-</span></span>
                <button class="edit-profile-btn" onclick="openEditProfileModal()" style="margin-top:10px;background:#C9D9FF;color:#222;border:none;border-radius:20px;padding:8px 18px;font-size:1rem;cursor:pointer;box-shadow:0 1px 4px #bbb;border:1px solid #888;transition:background 0.2s;">Edit profile</button>
              </div>
              <img id="profileImg" class="profile-img" src="image/robot.png" alt="Profile" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #222;background:#fff;" />
            </div>
            <div id="quizContainer" style="background:#C9D9FF;border-radius:12px;box-shadow:0 2px 8px rgba(30,58,95,0.10);padding:18px 20px;border:1px solid #bbb;max-height:350px;overflow-y:auto;"></div>
          </div>
          <!-- Right: News/Events/Announcements -->
          <div style="flex:1;display:flex;flex-direction:column;gap:18px;">
            <div class="tab-btns" style="display:flex;gap:15px;margin-bottom:10px;align-items:center;">
              <button class="tab-btn" id="tabEvents" onclick="toggleStudentNewsTab('event')" style="background:transparent;color:#1e3a5f;border:2px solid #1e3a5f;border-radius:50px;padding:10px 24px;font-size:1.05rem;font-weight:500;cursor:pointer;transition:all 0.18s;outline:none;">Events</button>
              <button class="tab-btn" id="tabNews" onclick="toggleStudentNewsTab('news')" style="background:transparent;color:#1e3a5f;border:2px solid #1e3a5f;border-radius:50px;padding:10px 24px;font-size:1.05rem;font-weight:500;cursor:pointer;transition:all 0.18s;outline:none;">News</button>
              <button class="tab-btn" id="tabAnnouncements" onclick="toggleStudentNewsTab('announcement')" style="background:transparent;color:#1e3a5f;border:2px solid #1e3a5f;border-radius:50px;padding:10px 24px;font-size:1.05rem;font-weight:500;cursor:pointer;transition:all 0.18s;outline:none;">Announcement</button>
            </div>
            <div id="studentNewsContainer" style="background:#C9D9FF;border-radius:18px;box-shadow:0 2px 8px rgba(30,58,95,0.10);padding:18px 20px;display:flex;flex-direction:column;gap:16px;border:1px solid #bbb;max-height:calc(100vh - 280px);overflow-y:auto;"></div>
          </div>
        </div>
        <div id="studentProfileSection" style="display:none;flex:1;flex-direction:column;align-items:flex-start;padding:32px 32px 32px 32px;">
  <div class="profile-card" style="background:#E7E7E7;border:1.2px solid #bbb;border-radius:12px;padding:20px 24px;box-shadow:0 2px 8px rgba(30,58,95,0.10);display:flex;align-items:center;justify-content:space-between;width:100%;max-width:1500px;">
    <div class="profile-info" style="display:flex;flex-direction:column;gap:6px;align-items:flex-start;">
      <strong style="font-size:1.18rem;color:#222;letter-spacing:0.01em;font-weight:700;">STUDENT PROFILE: <span style="color:#176c2f;font-size:1.1rem;vertical-align:middle;">●</span></strong>
      <span style="font-size:1.08rem;color:#222;font-weight:600;">Name: <span id="profileName2">Student</span></span>
      <span style="font-size:1.08rem;color:#222;font-weight:500;">Student ID: <span id="profileNo2">-</span></span>
      <span style="font-size:1.08rem;color:#222;font-weight:500;">Course &amp; Section: <span id="profileCourse2">-</span></span>
      <span style="font-size:1.08rem;color:#222;font-weight:500;">Contact no. : <span id="profileContact2">-</span></span>
      <span style="font-size:1.08rem;color:#222;font-weight:500;">Email : <span id="profileEmail2">-</span></span>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
      <img id="profileImg2" class="profile-img" src="image/robot.png" alt="Profile" style="width:90px;height:90px;border-radius:50%;object-fit:cover;border:2.5px solid #222;background:#fff;box-shadow:0 1px 4px #bbb;" />
      <button class="edit-profile-btn" onclick="openEditProfileModal()" style="background:#C9D9FF;color:#222;border:none;border-radius:30px;padding:7px 22px;font-size:1rem;cursor:pointer;box-shadow:0 1px 4px #bbb;border:1px solid #bbb;transition:background 0.2s;">Edit profile</button>
    </div>
  </div>
</div>
        <div id="editProfileModal" class="modal" style="display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
          <div class="modal-content" style="background:#e6e6e6;border-radius:16px;border:1.5px solid #222;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:32px 28px 24px 28px;max-width:350px;margin:auto;display:flex;flex-direction:column;align-items:center;position:relative;">
            <button onclick="closeEditProfileModal()" style="position:absolute;top:18px;left:50%;transform:translateX(-50%);background:#fff;border:1.5px solid #222;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#222;cursor:pointer;box-shadow:0 1px 4px #bbb;z-index:2;">&times;</button>
            <h3 style="margin-bottom:18px;color:#222;font-size:1.18rem;font-weight:600;text-align:center;">Edit Profile</h3>
            <label for="editProfileImgInput" style="background:#bfcbe6;color:#222;border:none;border-radius:8px;padding:8px 18px;font-size:1rem;cursor:pointer;box-shadow:0 1px 4px #bbb;margin-bottom:8px;display:inline-block;">Choose File</label>
            <input type="file" id="editProfileImgInput" accept="image/*" style="display:none;" />
            <img id="editProfileImgPreview" src="image/robot.png" class="profile-img" style="margin-bottom:12px;width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #222;background:#fff;" />
            <input type="text" id="editProfileNo" placeholder="Student No." style="width:100%;padding:12px 16px;margin-bottom:10px;border-radius:12px;border:1px solid #bbb;background:#fff;font-size:1.08rem;font-weight:500;" />
            <input type="text" id="editProfileName" placeholder="Name" style="width:100%;padding:12px 16px;margin-bottom:10px;border-radius:12px;border:1px solid #bbb;background:#fff;font-size:1.08rem;font-weight:500;" />
            <input type="text" id="editProfileCourse" placeholder="Course and Section" style="width:100%;padding:12px 16px;margin-bottom:10px;border-radius:12px;border:1px solid #bbb;background:#fff;font-size:1.08rem;font-weight:500;" />
            <input type="email" id="editProfileEmail" placeholder="Email" style="width:100%;padding:12px 16px;margin-bottom:10px;border-radius:12px;border:1px solid #bbb;background:#fff;font-size:1.08rem;font-weight:500;" />
            <input type="text" id="editProfileContact" placeholder="Contact Number" style="width:100%;padding:12px 16px;margin-bottom:10px;border-radius:12px;border:1px solid #bbb;background:#fff;font-size:1.08rem;font-weight:500;" />
            <input type="password" id="editProfilePassword" placeholder="New Password" style="width:100%;padding:12px 16px;margin-bottom:18px;border-radius:12px;border:1px solid #bbb;background:#fff;font-size:1.08rem;font-weight:500;" />
            <button type="button" class="edit-profile-btn" onclick="saveProfileEdit()" style="width:100%;background:#bfcbe6;color:#222;border:none;border-radius:12px;padding:10px 0;font-size:1.08rem;font-weight:600;box-shadow:0 1px 4px #bbb;">Save</button>
          </div>
        </div>
        <!-- Chat Modal -->
        <div id="chatModal" class="modal" style="display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
          <div style="background:#fff;border-radius:16px;border:2px solid #222;box-shadow:0 4px 16px rgba(0,0,0,0.2);width:90%;max-width:800px;height:85vh;display:flex;flex-direction:column;position:relative;">
            <button onclick="closeChatModal()" style="position:absolute;top:12px;right:12px;background:#fff;border:2px solid #222;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#222;cursor:pointer;z-index:2;">&times;</button>
            <div style="padding:20px;border-bottom:2px solid #ddd;display:flex;justify-content:space-between;align-items:center;">
              <h3 style="margin:0;font-size:1.5rem;color:#1e3a5f;font-weight:700;">Chat with Students</h3>
            </div>
            <div style="display:flex;flex:1;overflow:hidden;">
              <!-- Student List -->
              <div id="studentListContainer" style="width:250px;border-right:2px solid #ddd;overflow-y:auto;background:#f5f5f5;">
                <div style="padding:12px;background:#C9D9FF;border-bottom:1px solid #ddd;">
                  <input type="text" id="studentSearchInput" placeholder="Search students..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #bbb;font-size:0.9rem;" />
                </div>
                <div id="studentList" style="padding:8px;">
                  <!-- Student list will be populated here -->
                </div>
              </div>
              <!-- Chat Area -->
              <div style="flex:1;display:flex;flex-direction:column;">
                <div id="chatHeader" style="padding:16px;border-bottom:2px solid #ddd;background:#C9D9FF;display:none;">
                  <h4 id="chatStudentName" style="margin:0;font-size:1.2rem;color:#1e3a5f;font-weight:600;"></h4>
                  <small id="chatStudentNo" style="color:#666;"></small>
                </div>
                <div id="chatMessages" style="flex:1;overflow-y:auto;padding:16px;background:#fafafa;">
                  <div style="text-align:center;color:#999;padding:40px;">Select a student to start chatting</div>
                </div>
                <div id="chatInputContainer" style="padding:16px;border-top:2px solid #ddd;background:#fff;display:none;">
                  <div style="display:flex;gap:8px;">
                    <input type="text" id="chatMessageInput" placeholder="Type a message..." style="flex:1;padding:12px;border-radius:8px;border:2px solid #ddd;font-size:1rem;" onkeypress="if(event.key==='Enter') sendChatMessage();" />
                    <button onclick="sendChatMessage()" style="background:#C9D9FF;color:#1e3a5f;border:2px solid #222;border-radius:8px;padding:12px 24px;font-size:1rem;font-weight:600;cursor:pointer;transition:background 0.2s;">Send</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      // Section switching for student dashboard/profile
      function showStudentSection(section) {
        document.getElementById('studentDashboardSection').style.display = section === 'dashboard' ? 'flex' : 'none';
        document.getElementById('studentProfileSection').style.display = section === 'profile' ? 'flex' : 'none';
        document.getElementById('dashboardTab').classList.toggle('active', section === 'dashboard');
        document.getElementById('profileTab').classList.toggle('active', section === 'profile');
        // Always render quizzes when switching sections
        renderStudentQuizzes();
      }

      // Profile modal logic
      function openEditProfileModal() {
        document.getElementById('editProfileModal').style.display = 'flex';
        var cur = JSON.parse(localStorage.getItem('currentStudent') || 'null');
        if (!cur) return;
        document.getElementById('editProfileNo').value = cur.studentNo || '';
        document.getElementById('editProfileName').value = cur.name || '';
        document.getElementById('editProfileCourse').value = cur.course || '';
        document.getElementById('editProfileEmail').value = cur.email || '';
        document.getElementById('editProfileContact').value = cur.contact || '';
        document.getElementById('editProfilePassword').value = '';
        document.getElementById('editProfileImgPreview').src = cur.profileImg || 'image/robot.png';
        document.getElementById('editProfileImgInput').value = '';
      }
      document.getElementById('editProfileImgInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (file) {
          var reader = new FileReader();
          reader.onload = function(ev) {
            document.getElementById('editProfileImgPreview').src = ev.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
      function closeEditProfileModal() {
        document.getElementById('editProfileModal').style.display = 'none';
      }
      function saveProfileEdit() {
        var cur = JSON.parse(localStorage.getItem('currentStudent') || 'null');
        if (!cur) return;
        var newNo = document.getElementById('editProfileNo').value.trim();
        var newName = document.getElementById('editProfileName').value.trim();
        var newCourse = document.getElementById('editProfileCourse').value.trim();
        var newEmail = document.getElementById('editProfileEmail').value.trim();
        var newContact = document.getElementById('editProfileContact').value.trim();
        var newPass = document.getElementById('editProfilePassword').value;
        var imgInput = document.getElementById('editProfileImgInput');
        var imgData = cur.profileImg || 'image/robot.png';
        if (!newNo || !newName || !newCourse || !newEmail || !newContact) {
          alert('Please fill all fields.');
          return;
        }
        function finishEdit(imgDataFinal) {
          cur.studentNo = newNo;
          cur.name = newName;
          cur.course = newCourse;
          cur.email = newEmail;
          cur.contact = newContact;
          if (newPass) cur.password = newPass;
          cur.profileImg = imgDataFinal;
          localStorage.setItem('currentStudent', JSON.stringify(cur));
          // Update in students array for admin
          var students = JSON.parse(localStorage.getItem('students') || '[]');
          var idx = students.findIndex(function(s){ return s.studentNo === cur.studentNo || s.no === cur.studentNo; });
          if (idx !== -1) {
            students[idx].studentNo = newNo;
            students[idx].no = newNo;
            students[idx].name = newName;
            students[idx].course = newCourse;
            students[idx].email = newEmail;
            students[idx].contact = newContact;
            if (newPass) students[idx].password = newPass;
            students[idx].profileImg = imgDataFinal;
          } else {
            students.push({ studentNo: newNo, no: newNo, name: newName, course: newCourse, email: newEmail, contact: newContact, password: newPass, profileImg: imgDataFinal });
          }
          localStorage.setItem('students', JSON.stringify(students));
          updateStudentProfileUI();
          closeEditProfileModal();
        }
        if (imgInput.files && imgInput.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            finishEdit(e.target.result);
          };
          reader.readAsDataURL(imgInput.files[0]);
        } else {
          finishEdit(imgData);
        }
      }
      function updateStudentProfileUI() {
        var cur = JSON.parse(localStorage.getItem('currentStudent') || 'null');
        if (!cur) return;
        // Update welcome message
        document.getElementById('studentName').textContent = cur.name;
        // Update profile cards
        document.getElementById('profileName').textContent = cur.name;
        document.getElementById('profileNo').textContent = cur.studentNo;
        document.getElementById('profileCourse').textContent = cur.course || '-';
        document.getElementById('profileImg').src = cur.profileImg || 'image/robot.png';
        document.getElementById('profileName2').textContent = cur.name;
        document.getElementById('profileNo2').textContent = cur.studentNo;
        document.getElementById('profileCourse2').textContent = cur.course || '-';
        document.getElementById('profileContact2').textContent = cur.contact || '-';
        document.getElementById('profileEmail2').textContent = cur.email || '-';
        document.getElementById('profileImg2').src = cur.profileImg || 'image/robot.png';
        // Update header profile
        document.getElementById('studentNameHeader').textContent = cur.name;
        document.getElementById('studentNoHeader').textContent = cur.studentNo;
        var headerAvatar = document.querySelector('.header .profile img.avatar');
        if (headerAvatar) headerAvatar.src = cur.profileImg || 'image/robot.png';
        // Always render quizzes after profile update
        setTimeout(renderStudentQuizzes, 0);
      }

      // Quiz rendering and taking
      function renderStudentQuizzes() {
        var quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
        var container = document.getElementById('quizContainer');
        if (!quizzes.length) {
          container.innerHTML = '<div class="quiz-card"><span>No quizzes available.</span></div>';
          return;
        }
        var html = '';
        quizzes.forEach(function(q, idx) {
          html += '<div class="quiz-card" style="background:#C9D9FF;border-radius:10px;box-shadow:0 1px 4px #bbb;padding:16px 18px;margin-bottom:14px;border:1px solid #dbe4f3;">';
          html += '<h4 style="font-size:1.08rem;color:#1e3a5f;margin-bottom:10px;">' + (idx+1) + '. ' + q.question + '</h4>';
          html += '<form onsubmit="event.preventDefault(); submitQuizAnswer(' + idx + ', this);">';
          html += '<div class="quiz-options" style="display:grid;grid-template-columns:1fr 1fr;gap:8px 32px;margin-bottom:10px;">';
          ['A','B','C','D'].forEach(function(opt, i) {
            html += '<label style="display:flex;align-items:center;gap:8px;font-size:1rem;color:#222;">';
            html += '<input type="radio" name="quiz'+idx+'" value="'+opt+'" required style="margin-right:6px;">';
            html += '<span>' + opt + '. ' + q.options[i] + '</span>';
            html += '</label>';
          });
          html += '</div>';
          html += '<button type="submit" class="quiz-submit-btn" style="background:#fff;color:#1e3a5f;border:none;border-radius:8px;padding:7px 18px;font-size:1rem;cursor:pointer;box-shadow:0 1px 4px #bbb;border:1px solid #bbb;transition:background 0.2s;">Submit</button>';
          html += '</form>';
          html += '<div id="quizResult'+idx+'" style="margin-top:8px;font-weight:bold;"></div>';
          html += '</div>';
        });
        container.innerHTML = html;
      }
      function submitQuizAnswer(idx, form) {
        var quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
        var selected = form.querySelector('input[type="radio"]:checked');
        var resultDiv = document.getElementById('quizResult'+idx);
        if (!selected) return;
        if (selected.value === quizzes[idx].correct) {
          resultDiv.textContent = 'Correct!';
          resultDiv.style.color = 'green';
        } else {
          resultDiv.textContent = 'Incorrect. Correct answer: ' + quizzes[idx].correct;
          resultDiv.style.color = 'crimson';
        }
      }

      // News/Events/Announcements rendering
      var studentNewsTab = 'event';
      function toggleStudentNewsTab(type) {
        studentNewsTab = type;
        // Tab toggle styling
        document.getElementById('tabEvents').style.background = '#fff';
        document.getElementById('tabEvents').style.color = '#1e3a5f';
        document.getElementById('tabNews').style.background = '#fff';
        document.getElementById('tabNews').style.color = '#1e3a5f';
        document.getElementById('tabAnnouncements').style.background = '#fff';
        document.getElementById('tabAnnouncements').style.color = '#1e3a5f';
        if(type==='event') {
          document.getElementById('tabEvents').style.background = '#eaf1ff';
          document.getElementById('tabEvents').style.color = '#18417f';
        } else if(type==='news') {
          document.getElementById('tabNews').style.background = '#eaf1ff';
          document.getElementById('tabNews').style.color = '#18417f';
        } else if(type==='announcement') {
          document.getElementById('tabAnnouncements').style.background = '#eaf1ff';
          document.getElementById('tabAnnouncements').style.color = '#18417f';
        }
        renderStudentNews();
      }
      function renderStudentNews() {
        var news = JSON.parse(localStorage.getItem('news') || '[]');
        var filtered = news.filter(function(n){return n.type===studentNewsTab;});
        var container = document.getElementById('studentNewsContainer');
        if (!filtered.length) {
          container.innerHTML = '<div class="news-card"><span>No '+studentNewsTab+'s available.</span></div>';
          return;
        }
        var html = '';
        filtered.slice().reverse().forEach(function(n) {
          html += '<div class="news-card" style="background:#eaf1ff;border-radius:32px;box-shadow:0 2px 8px rgba(30,58,95,0.10);padding:28px 36px;min-height:180px;border:1px solid #bbb;width:100%;display:flex;flex-direction:row;align-items:flex-start;gap:32px;">';
          html += '<div style="width:180px;height:180px;min-width:180px;min-height:180px;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:24px;border:2px solid #222;box-shadow:0 1px 4px #bbb;margin-right:24px;">';
          if (n.img && n.img !== "" && n.img !== undefined && n.img !== null) {
            var imgSrc = n.img;
            if (!/^data:/.test(imgSrc) && !/^https?:/.test(imgSrc) && !imgSrc.startsWith('image/')) {
              imgSrc = 'image/' + imgSrc;
            }
            html += '<img src="'+imgSrc+'" alt="news image" style="width:160px;height:160px;object-fit:cover;border-radius:18px;">';
          } else {
            html += '<span style="font-size:1.1rem;color:#222;font-weight:600;">Image</span>';
          }
          html += '</div>';
          html += '<div style="flex:1;display:flex;flex-direction:column;justify-content:flex-start;gap:10px;height:100%;position:relative;">';
          html += '<h4 style="font-size:1.25rem;color:#1e3a5f;margin-bottom:0;font-weight:700;">' + (n.title || (n.type.charAt(0).toUpperCase() + n.type.slice(1))) + '</h4>';
          html += '<div style="font-size:1.08rem;color:#222;font-weight:500;margin-bottom:0;">' + n.desc + '</div>';
          if (n.schedule || n.scheduleDate) html += '<div style="font-size:1.08rem;color:#176c2f;font-weight:600;position:absolute;bottom:0;left:0;">Schedule: ' + (n.schedule || n.scheduleDate) + '</div>';
          html += '</div>';
          html += '</div>';
        });
        container.innerHTML = html;
      }

      // On load, set up everything
      window.onload = function () {
        var cur = JSON.parse(localStorage.getItem("currentStudent") || "null");
        if (!cur) {
          window.location.href = "index.html";
          return;
        }
        // Merge with full student data from students array
        var students = JSON.parse(localStorage.getItem('students') || '[]');
        var fullStudent = students.find(function(s) {
          return (s.no === cur.studentNo || s.studentNo === cur.studentNo) || 
                 (s.email === cur.email && cur.email);
        });
        if (fullStudent) {
          // Merge full student data into currentStudent
          cur.course = cur.course || fullStudent.course || '';
          cur.email = cur.email || fullStudent.email || '';
          cur.contact = cur.contact || fullStudent.contact || '';
          cur.profileImg = cur.profileImg || fullStudent.profileImg || 'image/robot.png';
          localStorage.setItem('currentStudent', JSON.stringify(cur));
        }
        document.getElementById("studentName").textContent = cur.name;
        // Note: studentNo is not in header, only studentNameHeader and studentNoHeader
        updateStudentProfileUI();
        renderStudentQuizzes(); // Ensure quizzes display immediately on login
        renderStudentNews();
        showStudentSection('dashboard'); // Always show dashboard with quizzes/news
      };
      // Modal close on outside click
      window.onclick = function (e) {
        if (e.target.classList && e.target.classList.contains("modal")) {
          e.target.style.display = "none";
          if (e.target.id === 'chatModal') {
            currentChatStudent = null;
          }
        }
      };
      function openStudentHelpModal() {
        document.getElementById('studentHelpModal').style.display = 'flex';
      }
      function closeStudentHelpModal() {
        document.getElementById('studentHelpModal').style.display = 'none';
      }

      // Chat functionality
      var currentChatStudent = null;
      function openChatModal() {
        document.getElementById('chatModal').style.display = 'flex';
        renderStudentList();
      }
      function closeChatModal() {
        document.getElementById('chatModal').style.display = 'none';
        currentChatStudent = null;
      }
      function renderStudentList() {
        var students = JSON.parse(localStorage.getItem('students') || '[]');
        var currentStudent = JSON.parse(localStorage.getItem('currentStudent') || 'null');
        if (!currentStudent) return;
        var container = document.getElementById('studentList');
        var html = '';
        students.forEach(function(s) {
          // Don't show current student in list
          if (s.no === currentStudent.studentNo || s.email === currentStudent.email) return;
          var studentName = s.name || 'Student';
          var studentNo = s.no || '-';
          var studentImg = s.profileImg || 'image/robot.png';
          html += '<div onclick="selectChatStudent(\'' + s.no + '\')" style="padding:12px;cursor:pointer;display:flex;align-items:center;gap:12px;border-bottom:1px solid #ddd;transition:background 0.2s;" onmouseover="this.style.background=\'#e0e0e0\'" onmouseout="this.style.background=\'transparent\'">';
          html += '<img src="' + studentImg + '" alt="' + studentName + '" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #222;" />';
          html += '<div style="flex:1;min-width:0;">';
          html += '<div style="font-weight:600;color:#1e3a5f;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + studentName + '</div>';
          html += '<div style="font-size:0.85rem;color:#666;">' + studentNo + '</div>';
          html += '</div>';
          html += '</div>';
        });
        if (!html) {
          html = '<div style="padding:20px;text-align:center;color:#999;">No other students available</div>';
        }
        container.innerHTML = html;
        // Add search functionality
        document.getElementById('studentSearchInput').addEventListener('input', function(e) {
          var searchTerm = e.target.value.toLowerCase();
          var items = container.querySelectorAll('div[onclick]');
          items.forEach(function(item) {
            var text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
          });
        });
      }
      function selectChatStudent(studentNo) {
        var students = JSON.parse(localStorage.getItem('students') || '[]');
        var student = students.find(function(s) { return s.no === studentNo; });
        if (!student) return;
        currentChatStudent = studentNo;
        // Show chat header
        document.getElementById('chatHeader').style.display = 'block';
        document.getElementById('chatStudentName').textContent = student.name || 'Student';
        document.getElementById('chatStudentNo').textContent = student.no || '-';
        // Show chat input
        document.getElementById('chatInputContainer').style.display = 'block';
        // Load and display messages
        renderChatMessages();
      }
      function renderChatMessages() {
        if (!currentChatStudent) return;
        var currentStudent = JSON.parse(localStorage.getItem('currentStudent') || 'null');
        if (!currentStudent) return;
        var chats = JSON.parse(localStorage.getItem('studentChats') || '{}');
        var currentStudentId = currentStudent.studentNo;
        var chatKey = [currentStudentId, currentChatStudent].sort().join('_');
        var messages = chats[chatKey] || [];
        var container = document.getElementById('chatMessages');
        var html = '';
        if (messages.length === 0) {
          html = '<div style="text-align:center;color:#999;padding:40px;">No messages yet. Start the conversation!</div>';
        } else {
          messages.forEach(function(msg) {
            var isSent = msg.from === currentStudentId;
            html += '<div style="display:flex;justify-content:' + (isSent ? 'flex-end' : 'flex-start') + ';margin-bottom:12px;">';
            html += '<div style="max-width:70%;background:' + (isSent ? '#C9D9FF' : '#e0e0e0') + ';padding:10px 14px;border-radius:12px;border:1px solid ' + (isSent ? '#94b5d9' : '#ccc') + ';">';
            html += '<div style="font-size:0.9rem;color:#1e3a5f;font-weight:600;margin-bottom:4px;">' + (msg.fromName || msg.from) + '</div>';
            html += '<div style="color:#222;font-size:1rem;word-wrap:break-word;">' + msg.text + '</div>';
            html += '<div style="font-size:0.75rem;color:#666;margin-top:4px;text-align:right;">' + (msg.time || '') + '</div>';
            html += '</div>';
            html += '</div>';
          });
        }
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
      }
      function sendChatMessage() {
        if (!currentChatStudent) return;
        var currentStudent = JSON.parse(localStorage.getItem('currentStudent') || 'null');
        if (!currentStudent) return;
        var input = document.getElementById('chatMessageInput');
        var messageText = input.value.trim();
        if (!messageText) return;
        var chats = JSON.parse(localStorage.getItem('studentChats') || '{}');
        var currentStudentId = currentStudent.studentNo;
        var chatKey = [currentStudentId, currentChatStudent].sort().join('_');
        if (!chats[chatKey]) chats[chatKey] = [];
        var now = new Date();
        var timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
        chats[chatKey].push({
          from: currentStudentId,
          fromName: currentStudent.name,
          to: currentChatStudent,
          text: messageText,
          time: timeStr,
          timestamp: now.getTime()
        });
        localStorage.setItem('studentChats', JSON.stringify(chats));
        input.value = '';
        renderChatMessages();
      }
    </script>
  </body>
</html>

